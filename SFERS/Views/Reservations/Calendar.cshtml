@model List<SFERS.Models.ViewModel.ReservationViewModel>
@{
    ViewData["Title"] = "Reservation Calendar";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-calendar-alt me-2"></i>Reservation Calendar</h2>
    <a asp-action="Create" class="btn btn-primary"><i class="fas fa-plus me-1"></i>New Reservation</a>
</div>

<div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <div>
            <button id="prevMonth" class="btn btn-sm btn-outline-secondary"><i class="fas fa-chevron-left"></i></button>
            <span id="currentMonth" class="mx-3 fw-bold fs-5"></span>
            <button id="nextMonth" class="btn btn-sm btn-outline-secondary"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div>
            <button id="todayBtn" class="btn btn-sm btn-primary">Today</button>
        </div>
    </div>
    <div class="card-body">
        <div id="calendar" class="table-responsive"></div>
    </div>
</div>

<div class="mt-4">
    <h5>Upcoming Reservations</h5>
    <div class="row">
        @foreach (var item in Model)
        {
            <div class="col-md-4 mb-3">
                <div class="card h-100 border-start border-4 @(item.Status == "Approved" ? "border-success" : item.Status == "Ongoing" ? "border-primary" : "border-warning")">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title mb-0">@item.RoomName</h6>
                            <span class="badge @(item.Status == "Approved" ? "bg-success" : item.Status == "Ongoing" ? "bg-primary" : "bg-warning text-dark")">@item.Status</span>
                        </div>
                        <p class="card-text text-muted small">
                            <i class="fas fa-calendar me-2"></i>@item.Date.ToShortDateString()<br>
                            <i class="fas fa-clock me-2"></i>@item.TimeSlot
                        </p>
                        <p class="small mb-0"><strong>Purpose:</strong> @item.Purpose</p>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        let currentDate = new Date();
        const reservations = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));

        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();

            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];

            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let calendarHTML = '<table class="table table-bordered text-center">';
            calendarHTML += '<thead><tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr></thead><tbody><tr>';

            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<td class="bg-light"></td>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                if ((day + firstDay - 1) % 7 === 0 && day > 1) {
                    calendarHTML += '</tr><tr>';
                }

                const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasReservation = reservations.some(r => r.Date.startsWith(currentDateStr));
                const isToday = day === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear();

                let cellClass = hasReservation ? 'bg-primary bg-opacity-10' : '';
                cellClass += isToday ? ' border border-primary border-2' : '';

                calendarHTML += `<td class="p-3 ${cellClass}">
                    <div class="fw-bold">${day}</div>
                    ${hasReservation ? '<small class="text-primary">‚óè Booked</small>' : ''}
                </td>`;
            }

            const remainingCells = (7 - (daysInMonth + firstDay) % 7) % 7;
            for (let i = 0; i < remainingCells; i++) {
                calendarHTML += '<td class="bg-light"></td>';
            }

            calendarHTML += '</tr></tbody></table>';
            document.getElementById('calendar').innerHTML = calendarHTML;
        }

        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });

        document.getElementById('todayBtn').addEventListener('click', () => {
            currentDate = new Date();
            renderCalendar(currentDate);
        });

        renderCalendar(currentDate);
    </script>
}
